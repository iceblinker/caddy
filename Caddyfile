{
    # Global Options
    email { $ACME_EM A I L }
    
    # CrowdSec Integration
    order crowdsec first
    crowdsec {
        api_url http://crowdsec:8080
        api_key { $CROWDSEC_API_ K E Y }
        ticker_interval 15s
    }

    # Global Rate Limiting Definition
    order rate_limit before basic_auth
    
    # Global Logging (JSON for parsing tools)
    log {
        format json
        output stdout
        level INFO
    }
}

# ------------------------------------------------------------------------------
# SNIPPETS
# ------------------------------------------------------------------------------

(cors) {
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Max-Age "3600"
    }

    # Intercept OPTIONS requests
    @options {
        method OPTIONS
    }
    respond @options "" 204
}

# ------------------------------------------------------------------------------
# SITES
# ------------------------------------------------------------------------------

# Example: Mediaflow Proxy
mediaflow. { $DOM A I N } {
    import cors
    crowdsec
    rate_limit {
        zone mediaflow_zone {
            key remote_host
            events 20
            window 1s
        }
    }

    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy mediaflow-proxy:8888
}

# Example: Jackett
jackett. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy jackett:9117 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Dozzle
dozzle. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy dozzle:8080 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: AIOStreams
$DOM A I N } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    log {
        format json
        output stdout
    }

    reverse_proxy aiostreams:3000 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Comet Stremio Addon
comet. { $DOM A I N } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }
    encode zstd gzip

    log {
        format json
        output stdout
    }

    reverse_proxy comet:8000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Ollama
ollama. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy ollama:11434 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Search API
search. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy search-api:8080 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: ChromaDB
chromadb. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy chromadb:8000 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Prowlarr
prowlarr. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy gluetun:9696 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: VixSrc Catalogs Addon
catalogs. { $DOM A I N } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy vixsrc-addon:3000 {
        transport http {
            keepalive 5m
            dial_timeout 2s
            response_header_timeout 30s
        }
        
        # Force DNS lookup retry to prevent stale IP routing
        lb_try_duration 1s
        lb_try_interval 250ms
        
        # Health check to detect when routing to wrong container
        health_uri /
        health_interval 10s
        health_timeout 2s
        health_status 2xx
    }
}

# Example: Leviathan Stremio Addon
leviathan. { $DOM A I N } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy leviathan:7000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: FlareSolverr
flaresolverr. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy gluetun:8191 {
        transport http {
            keepalive 5m
        }
    }
}



# Example: Sootio
sootio. { $DOM A I N } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy sootio:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Streamvix
streamvix. { $DOM A I N } {
    import cors
    
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy streamvix:7860 {
        # Remove CORS headers from addon responses before Caddy adds its own
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Max-Age
        
        transport http {
            keepalive 5m
        }
    }
}

# Example: NZBDav
nzbdav. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }
        
    basic_auth / {
        admin $2y$05$1v1lXF0K1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1
    }

    log {
        format json
        output stdout
    }

    reverse_proxy nzbdav:80 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: UsenetStreamer EN
usenetstreamer-en. { $DOM A I N }, usenetstreamer. { $DOM AIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer-en:7005 {
        transport http {
            keepalive 5m
        }
    }
}
    
# Example   :  Cors ar io Viola
corsario. { $DOM A I N } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy corsario:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: UsenetS   t ream er  ES
usenetstreamer-es. { $DOM A I N } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer-es:7005 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: UsenetS          t  re am  er  IT
usenetstreamer-it. { $ DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer-it:7005 {
        transport http {
        }
    }
}

# Example: Grafana
grafana.{$DOMAIN} {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy grafana:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: CORS Anywhere
cors.{$DOMAIN} {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy cors-anywhere:8080 {
        header_up X-Requested-With "XMLHttpRequest"
        header_up Origin "https://iceblinker.vip"
        transport http {
            keepalive 5m
        }
    }
}
