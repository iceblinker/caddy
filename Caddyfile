{
    # Global Options
    email {$ACME_EMAIL}
    
    # CrowdSec Integration
    order crowdsec first
    crowdsec {
        api_url http://crowdsec:8080
        api_key {$CROWDSEC_API_KEY}
        ticker_interval 15s
    }

    # Global Rate Limiting Definition
    order rate_limit before basicauth
    
    # Global Logging (JSON for parsing tools)
    log {
        format json
        output stdout
        level INFO
    }
}

# ------------------------------------------------------------------------------
# SITES (Fully Expanded / No Imports for Max Robustness)
# ------------------------------------------------------------------------------

# Example: Mediaflow Proxy
# key request: mediaflow.your-domain.com
mediaflow.{$DOMAIN} {
    # Active Security
    crowdsec
    rate_limit {
        zone mediaflow_zone {
            key {remote_host}
            events 20
            window 1s
        }
    }

    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        file
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy mediaflow-proxy:8888 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        
        # Health Checks
        lb_policy first
        health_uri /
        health_interval 30s
        health_timeout 5s
    }
}

# Example: Jackett
# key request: jackett.your-domain.com
jackett.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        file
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy jackett:9117 {
        # Robust proxy settings
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
    }
}

# Example: Dozzle
# key request: dozzle.your-domain.com
dozzle.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy dozzle:8080 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        # max_conns_per_host 50
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: AIOStreams
# Example: AIOStreams
aiostreams.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        
        # CORS Headers (Fix for Stremio/Browser access)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"

        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy aiostreams:3000 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        # max_conns_per_host 50
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Ollama
ollama.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy ollama:11434 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Search API
search.{$DOMAIN} {
    # Note: search-api port is 8080 internal. We map to 8081 locally to avoid conflict if any, or just rely on subdomain.
    # User guide: http://search-api:8080
    
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy search-api:8080 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: ChromaDB
chromadb.{$DOMAIN} {
    # Note: chromadb port 8000. 
    # User guide: http://chromadb:8000
    
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy chromadb:8000 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Prowlarr (via Gluetun/VPN)
# key request: prowlarr.your-domain.com
prowlarr.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    # Proxy ID: 44
    reverse_proxy gluetun:9696 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: VixSrc Catalogs Addon
# key request: catalogs.your-domain.com
catalogs.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        
        # CORS Headers (Fix for Stremio/Browser access)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"

        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy vixsrc-addon:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: FlareSolverr
# key request: flaresolverr.your-domain.com
flaresolverr.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy gluetun:8191 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Carsario / Viola
# key request: corsario.your-domain.com
corsario.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        
        # CORS Headers (Fix for Stremio/Browser access)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"

        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy corsario:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: My Stremio Addon
# key request: stremio-addon.your-domain.com
stremio-addon.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        
        # CORS Headers (Fix for Stremio/Browser access)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"

        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy my-stremio-addon:7000 {
        transport http {
            keepalive 5m
        }
    }
}

# Homepage (The Bridge)
# key request: home.your-domain.com or just localhost
# Note: Since localhost overlaps with mediaflow (localhost:8080) and others, Caddy handles specific ports.
# This block handles default ports if not matched elsewhere, or we can use specific domain.
home.{$DOMAIN}, {$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }

    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip
    
    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy homepage:3000 {
        # header_up X-Real-IP {http.request.remote.host}
        # header_up X-Forwarded-Proto {http.request.scheme}
        # max_conns_per_host 50
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Streamvix
# key request: streamvix.your-domain.com
streamvix.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        
        # CORS Headers (Fix for Stremio/Browser access)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"

        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy streamvix:7860 {
        header_up X-Forwarded-Host {host}
        transport http {
            keepalive 5m
        }
    }
}

# Example: NZBDav (WebDAV for Usenet)
# key request: nzbdav.your-domain.com
nzbdav.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy nzbdav:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Usenetstreamer (Usenet Stremio Addon)
# key request: usenetstreamer.your-domain.com
usenetstreamer.{$DOMAIN} {
    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self'; object-src 'none';"
        
        # CORS Headers (Fix for Stremio/Browser access)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
        Access-Control-Expose-Headers "Content-Length,Content-Range"

        -Server
        -X-Powered-By
    }
    
    # Performance
    @compressible {
        path *.js *.css *.html *.json *.xml *.txt *.svg *.md *.yaml *.yml
    }
    encode @compressible zstd gzip

    # Common Log
    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer:7005 {
        transport http {
            keepalive 5m
        }
    }
}

