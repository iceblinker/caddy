{
    # Global Options
    email {$ACME_EMAIL }

    # CrowdSec Integration
    order crowdsec first
    crowdsec {
        api_url http://crowdsec:8080
        api_key {$CROWDSEC_API_KEY }
        ticker_interval 15s
    }

    # Global Rate Limiting Definition
    order rate_limit before basic_auth

    # Global Logging (JSON for parsing tools)
    log {
        format json
        output stdout
        level INFO
    }
}

# ------------------------------------------------------------------------------
# SNIPPETS
# ------------------------------------------------------------------------------

(cors) {
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Max-Age "3600"
    }

    # Intercept OPTIONS requests
    @options {
        method OPTIONS
    }
    respond @options "" 204
}

# ------------------------------------------------------------------------------
# SITES
# ------------------------------------------------------------------------------

# Example: Mediaflow Proxy
mediaflow. {$DOMAIN } {
    crowdsec
    rate_limit {
        zone mediaflow_zone {
            key remote_host
            events 20
            window 1s
        }
    }

    # Security Headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy mediaflow-proxy:8888
}

# Example: Jackett
jackett. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy jackett:9117 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Dozzle
dozzle. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy dozzle:8080 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: AIOStreams
aiostreams. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    @static {
        path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.webp
    }
    header @static Cache-Control "public, max-age=31536000"

    log {
        format json
        output stdout
    }

    reverse_proxy aiostreams:3000 {
        # Strip duplicate headers from addon responses
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Max-Age

        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Comet Stremio Addon
comet. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }
    encode zstd gzip

    log {
        format json
        output stdout
    }

    reverse_proxy comet:8000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Ollama
ollama. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy ollama:11434 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Search API
search. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy search-api:8080 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: ChromaDB
chromadb. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy chromadb:8000 {
        transport http {
            keepalive 5m
        }
    }
    request_body 20MB
}

# Example: Prowlarr
prowlarr. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy gluetun:9696 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: VixSrc Catalogs Addon
catalogs. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy vixsrc-addon:3003 {
        transport http {
            keepalive 5m
            dial_timeout 2s
            response_header_timeout 30s
        }

        # Force DNS lookup retry to prevent stale IP routing
        lb_try_duration 1s
        lb_try_interval 250ms

        # Health check to detect when routing to wrong container
        health_uri /
        health_interval 10s
        health_timeout 2s
        health_status 2xx
    }
}

# Example: Leviathan Stremio Addon
leviathan. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy leviathan:7000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: FlareSolverr
flaresolverr. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy gluetun:8191 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: NZBHydra2
nzbhydra. {$DOMAIN }, nzbhydra2. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy nzbhydra:5076 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Sootio
sootio. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy sootio:3002 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Streamvix
streamvix. {$DOMAIN } {
    import cors

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "ALLOWALL"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy streamvix:7860 {
        # Remove CORS headers from addon responses before Caddy adds its own
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Max-Age

        transport http {
            keepalive 5m
        }
    }
}

# Example: NZBDav
nzbdav. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    # Basic Auth: Password is your SABnzbd API Key
    basic_auth {
        admin JDJ5JDA1JExRSHp6L29uS25aSDZ2NXV0WW96YnVTeVR2ak0zdjU4UmE0WGFKSmNqQkRWUDRGNHY2R0tH
    }

    log {
        format json
        output stdout
    }

    reverse_proxy nzbdav:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: UsenetStreamer EN
usenetstreamer-en. {$DOMAIN }, usenetstreamer. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer-en:7005 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Corsario Viola
corsario. {$DOMAIN } {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy corsario:3001 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: UsenetStreamer ES
usenetstreamer-es. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer-es:7005 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: UsenetStreamer IT
usenetstreamer-it. {$DOMAIN } {
    import cors
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy usenetstreamer-it:7005 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: Grafana
grafana.{$DOMAIN} {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    reverse_proxy grafana:3000 {
        transport http {
            keepalive 5m
        }
    }
}

# Example: CORS Anywhere
cors.{$DOMAIN} {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        X-Robots-Tag "noindex, nofollow"
    }

    log {
        format json
        output stdout
    }

    reverse_proxy cors-anywhere:8080 {
        header_up X-Requested-With "XMLHttpRequest"
        header_up Origin "https://iceblinker.vip"
        transport http {
            keepalive 5m
        }
    }
}
