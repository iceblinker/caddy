services:
  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: jackett
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9117/UI/Dashboard || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    volumes:
      - jackett_config:/config
    networks:
      - caddy_net
      - ai_network

  redis:
    image: redis:alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  cors-anywhere:
    image: testcab/cors-anywhere:latest
    container_name: cors-anywhere
    restart: unless-stopped
    environment:
      - PORT=8080
      - CORSANYWHERE_WHITELIST=https://iceblinker.vip,https://stremio.com,https://web.stremio.com
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "http://localhost:8080" ]
      interval: 30s
      timeout: 10s
      retries: 3

  aiostreams:
    image: ghcr.io/viren070/aiostreams:latest
    container_name: aiostreams
    restart: unless-stopped
    environment:
      - PORT=3000
      - HOST=0.0.0.0
      - SECRET_KEY=35c6780e909247605971936c25a0b9435b6a5123d4e687890a1b2c3d4e5f6789
      - BASE_URL=https://aiostreams.138.199.156.62.sslip.io
      - MEDIAFLOW_URL=http://mediaflow-proxy:8888
      - MEDIAFLOW_API_PASSWORD=${API_PASSWORD}

    volumes:
      - aiostreams_data:/app/data
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  corsario-db:
    image: postgres:15-alpine
    container_name: corsario-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=corsario
      - POSTGRES_PASSWORD=corsario
      - POSTGRES_DB=corsario
    volumes:
      - corsario_db_data:/var/lib/postgresql/data
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U corsario" ]
      interval: 10s
      timeout: 5s
      retries: 5

  corsario:
    build: ../corsario-viola
    container_name: corsario
    restart: unless-stopped
    ports:
      - "3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://corsario:corsario@corsario-db:5432/corsario
      - PORT=3000
    depends_on:
      corsario-db:
        condition: service_healthy
    networks:
      - caddy_net
      - ai_network

  comet-db:
    image: postgres:15-alpine
    container_name: comet-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=comet
      - POSTGRES_PASSWORD=comet
      - POSTGRES_DB=comet
    volumes:
      - comet_db_data:/var/lib/postgresql/data
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U comet" ]
      interval: 10s
      timeout: 5s
      retries: 5

  comet:
    build: ../comet
    container_name: comet
    restart: unless-stopped
    env_file:
      - ../comet/.env
    environment:
      - DATABASE_URL=postgresql://comet:comet@comet-db:5432/comet
    depends_on:
      comet-db:
        condition: service_healthy
    networks:
      - caddy_net
      - ai_network

  nzbdav:
    image: nzbdav/nzbdav:latest
    container_name: nzbdav
    restart: unless-stopped
    environment:
      - PORT=3000
    volumes:
      - ./downloads:/data # Default mapping, user should update
    networks:
      - caddy_net
      - ai_network

  sootio-db:
    image: postgres:15-alpine
    container_name: sootio-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sootio
      - POSTGRES_PASSWORD=sootio
      - POSTGRES_DB=sootio
    volumes:
      - sootio_db_data:/var/lib/postgresql/data
    networks:
      - caddy_net
      - ai_network

  sootio:
    build: ../sootio
    container_name: sootio
    restart: unless-stopped
    env_file:
      - .env
      - ../sootio/.env
    environment:
      - ADDON_URL=https://sootio.${DOMAIN}
      - PORT=3000
      - DATABASE_URL=postgresql://sootio:sootio@sootio-db:5432/sootio
      - FLARESOLVERR_URL=http://gluetun:8191
      - SCRAPER_TIMEOUT=60000
      - SEARCH_TIMEOUT_MS=65000
      - LOG_LEVEL=debug
      - CACHE_BACKEND=postgres
      - DEBRID_HTTP_PROXY=http://gluetun:8191
    command: [ "node", "--max-old-space-size=2048", "--expose-gc", "cluster.js" ]
    depends_on:
      - sootio-db
    networks:
      - caddy_net
      - ai_network

  leviathan:
    build: ../leviathan
    container_name: leviathan
    restart: unless-stopped
    ports:
      - "7001:7000"
    environment:
      - PORT=7000
      - NODE_ENV=production
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - caddy_net
      - ai_network

  vixsrc-addon:
    build: ../vixsrc-catalogs
    container_name: vixsrc-addon
    restart: unless-stopped
    environment:
      - PORT=3000
    networks:
      - caddy_net
      - ai_network

volumes:
  jackett_config:
  aiostreams_data:
  corsario_db_data:
  comet_db_data:
  sootio_db_data:


networks:
  caddy_net:
    external: true
  ai_network:
    external: true
