services:
  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: jackett
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9117/UI/Dashboard || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    volumes:
      - jackett_config:/config
    networks:
      - caddy_net

  aiostreams:
    image: ghcr.io/viren070/aiostreams:latest
    container_name: aiostreams
    restart: unless-stopped
    environment:
      - PORT=3000
      - HOST=0.0.0.0
      - SECRET_KEY=35c6780e909247605971936c25a0b9435b6a5123d4e687890a1b2c3d4e5f6789
      - BASE_URL=https://aiostreams.138.199.156.62.sslip.io
      - MEDIAFLOW_URL=http://mediaflow-proxy:8888
      - MEDIAFLOW_API_PASSWORD=${API_PASSWORD}

    volumes:
      - aiostreams_data:/app/data
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  corsario-db:
    image: postgres:15-alpine
    container_name: corsario-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=corsario
      - POSTGRES_PASSWORD=corsario
      - POSTGRES_DB=corsario
    volumes:
      - corsario_db_data:/var/lib/postgresql/data
    networks:
      - caddy_net
      - ai_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U corsario" ]
      interval: 10s
      timeout: 5s
      retries: 5

  corsario:
    build: ../corsario-viola
    container_name: corsario
    restart: unless-stopped
    ports:
      - "3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://corsario:corsario@corsario-db:5432/corsario
      - PORT=3000
    depends_on:
      corsario-db:
        condition: service_healthy
    networks:
      - caddy_net
      - ai_network

  nzbdav:
    image: nzbdav/nzbdav:latest
    container_name: nzbdav
    restart: unless-stopped
    environment:
      - PORT=3000
    volumes:
      - ./downloads:/data # Default mapping, user should update
    networks:
      - caddy_net

  sootio-db:
    image: postgres:15-alpine
    container_name: sootio-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sootio
      - POSTGRES_PASSWORD=sootio
      - POSTGRES_DB=sootio
    volumes:
      - sootio_db_data:/var/lib/postgresql/data
    networks:
      - caddy_net

  sootio:
    build: ../sootio-stremio-addon
    container_name: sootio
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - ADDON_URL=https://sootio.${DOMAIN}
      - PORT=55771
      - DATABASE_URL=postgresql://sootio:sootio@sootio-db:5432/sootio
    depends_on:
      - sootio-db
    networks:
      - caddy_net

volumes:
  jackett_config:
  aiostreams_data:
  corsario_db_data:
  sootio_db_data:


networks:
  caddy_net:
    external: true
  ai_network:
    external: true
